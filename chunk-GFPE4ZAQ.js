import{a as Q}from"./chunk-K3A6S7JU.js";import{a as K}from"./chunk-DVCEIMDV.js";import{a as J}from"./chunk-4QIIHPU5.js";import{a as X,c as Z,h as ee,m as te,n as ie,o as ne,p as re}from"./chunk-6TR5I43M.js";import{$ as j,$a as S,B as g,Da as c,Ea as N,Ka as m,Lb as A,Pa as p,R as W,Sa as d,W as U,Xb as z,Yb as G,Za as i,Zb as Y,_a as n,a as P,ab as C,ac as q,b as R,bb as E,cb as w,db as _,eb as u,hb as D,ia as b,ib as r,ja as h,jb as V,ka as O,kb as v,la as L,lb as F,nb as B,ob as T,p as y,pb as I,q as x,rb as H,ub as $,zb as k}from"./chunk-LV7AXBPZ.js";var M=class s{constructor(t){this.http=t}apiUrl=`${K.apiBaseUrl}/driver`;getBuses(){return this.http.get(`${this.apiUrl}/buses`).pipe(g(t=>(console.error("Error fetching buses:",t),y({buses:[]}))))}startTrip(t,e){return this.http.post(`${this.apiUrl}/start-trip`,{busId:t,driverId:e}).pipe(g(a=>(console.error("Error starting trip:",a),x(()=>a))))}endTrip(t){return this.http.post(`${this.apiUrl}/end-trip`,{busId:t}).pipe(g(e=>(console.error("Error ending trip:",e),x(()=>e))))}updateLocation(t,e,a,o=0){return this.http.post(`${this.apiUrl}/update-location`,{busId:t,latitude:e,longitude:a,heading:o}).pipe(g(l=>(console.error("Error updating location:",l),y({success:!1}))))}recordStation(t,e){return this.http.post(`${this.apiUrl}/record-station`,{busId:t,stationName:e}).pipe(g(a=>(console.error("Error recording station:",a),y({success:!1}))))}reportIssue(t,e,a){return this.http.post(`${this.apiUrl}/report-issue`,{busId:t,issueType:e,description:a}).pipe(g(o=>(console.error("Error reporting issue:",o),x(()=>o))))}restoreBus(t){return this.http.post(`${this.apiUrl}/restore-bus`,{busId:t}).pipe(g(e=>(console.error("Error restoring bus:",e),x(()=>e))))}static \u0275fac=function(e){return new(e||s)(U(J))};static \u0275prov=W({token:s,factory:s.\u0275fac,providedIn:"root"})};var le=(s,t,e)=>({"bg-green-100 text-green-800":s,"bg-red-100 text-red-800":t,"bg-gray-100 text-gray-800":e});function ce(s,t){if(s&1&&(C(0),i(1,"p",38),r(2),n(),E()),s&2){let e,a=u(2);c(2),v("Route: ",(e=a.currentBus())==null?null:e.routeName,"")}}function ue(s,t){if(s&1&&(C(0),i(1,"div",39)(2,"div",14),O(),i(3,"svg",40),S(4,"path",41)(5,"path",42),n(),L(),i(6,"div",18)(7,"p",19),r(8,"Current Location"),n(),i(9,"p",43),r(10),n()()()(),E()),s&2){let e=u(2);c(10),F(" ",e.location().lat.toFixed(6),", ",e.location().lng.toFixed(6)," ")}}function de(s,t){s&1&&(i(0,"div",44)(1,"p",45),r(2,"Location not yet available. Ensure location services are enabled."),n()())}function me(s,t){s&1&&S(0,"span",46)}function pe(s,t){if(s&1){let e=w();C(0),i(1,"div",16)(2,"div",17)(3,"div",18)(4,"p",19),r(5,"Current Bus"),n(),i(6,"h3",20),r(7),n(),p(8,ce,3,1,"ng-container",21),n(),i(9,"span",22),r(10,"Active Trip"),n()()(),p(11,ue,11,2,"ng-container",10)(12,de,3,0,"ng-template",null,2,k),i(14,"div",23),p(15,me,1,0,"span",24),i(16,"span",25),r(17),n()(),i(18,"div",26)(19,"h3",12),r(20,"Report Issue"),n(),i(21,"div",26)(22,"label",27),r(23,"Issue Type"),n(),i(24,"select",28),I("ngModelChange",function(o){b(e);let l=u();return T(l.issueType,o)||(l.issueType=o),h(o)}),i(25,"option",29),r(26,"Select an issue type"),n(),i(27,"option",30),r(28,"Mechanical Failure"),n(),i(29,"option",31),r(30,"Electrical Issue"),n(),i(31,"option",32),r(32,"Accident"),n(),i(33,"option",33),r(34,"Other"),n()()(),i(35,"div",26)(36,"label",34),r(37,"Description"),n(),i(38,"textarea",35),I("ngModelChange",function(o){b(e);let l=u();return T(l.issueDescription,o)||(l.issueDescription=o),h(o)}),n()(),i(39,"button",36),_("click",function(){b(e);let o=u();return h(o.handleReportIssue())}),r(40," Report Issue & Mark Bus Out of Service "),n()(),i(41,"button",37),_("click",function(){b(e);let o=u();return h(o.handleEndTrip())}),r(42," End Trip "),n(),E()}if(s&2){let e,a,o=D(13),l=u();c(7),v("Bus ",(e=l.currentBus())==null?null:e.number,""),c(),d("ngIf",(a=l.currentBus())==null?null:a.routeName),c(3),d("ngIf",l.location())("ngIfElse",o),c(4),d("ngIf",l.isTracking()),c(2),V(l.isTracking()?"Live tracking active":"Tracking paused"),c(7),B("ngModel",l.issueType),c(14),B("ngModel",l.issueDescription)}}function ge(s,t){if(s&1&&(i(0,"option",58),r(1),n()),s&2){let e=t.$implicit;d("value",e.id),c(),F(" Bus ",e.number,"",e.routeName?" - "+e.routeName:""," ")}}function be(s,t){s&1&&(i(0,"option",59),r(1,"No buses available"),n())}function he(s,t){if(s&1){let e=w();i(0,"div",47)(1,"div",26),O(),i(2,"svg",48),S(3,"path",49),n()(),L(),i(4,"p",50),r(5,"No active trip"),n(),i(6,"p",51),r(7,"Select a bus below to start your trip"),n(),i(8,"div",52)(9,"label",53),r(10,"Select Bus"),n(),i(11,"select",54),I("ngModelChange",function(o){b(e);let l=u();return T(l.selectedBus,o)||(l.selectedBus=o),h(o)}),i(12,"option",29),r(13,"Choose a bus"),n(),p(14,ge,2,3,"option",55)(15,be,2,0,"option",56),n(),i(16,"button",57),_("click",function(){b(e);let o=u();return h(o.handleStartTrip())}),r(17," Start Trip "),n()()()}if(s&2){let e=u();c(11),B("ngModel",e.selectedBus),c(3),d("ngForOf",e.availableBuses()),c(),d("ngIf",e.availableBuses().length===0),c(),d("disabled",!e.selectedBus()||e.availableBuses().length===0)}}function ve(s,t){if(s&1&&(i(0,"div",68),r(1),n()),s&2){let e=u().$implicit;c(),v(" Route: ",e.routeName," ")}}function fe(s,t){if(s&1){let e=w();i(0,"div",69)(1,"button",70),_("click",function(){b(e);let o=u().$implicit,l=u(2);return h(l.handleRestoreBus(o.id))}),r(2,"restore bus to avilable"),n()()}}function xe(s,t){if(s&1&&(i(0,"div",62)(1,"div",63)(2,"div",64),r(3),n(),i(4,"span",65),r(5),n()(),p(6,ve,2,1,"div",66)(7,fe,3,0,"div",67),n()),s&2){let e=t.$implicit;c(3),v("Bus ",e.number,""),c(),d("ngClass",$(5,le,e.status==="active",e.status==="out-of-service",e.status!=="active"&&e.status!=="out-of-service")),c(),V(e.status),c(),d("ngIf",e.routeName),c(),d("ngIf",e.status==="out-of-service")}}function _e(s,t){if(s&1&&(i(0,"div")(1,"div",60),p(2,xe,8,9,"div",61),n()()),s&2){let e=u();c(2),d("ngForOf",e.buses())}}function ye(s,t){s&1&&(i(0,"div",71),r(1," No buses in the system "),n())}var oe=class s{constructor(t,e){this.apiService=t;this.authService=e;A(()=>{let a=this.buses().filter(o=>{let l=(o.status||"").toLowerCase();return l!=="active"&&l!=="out-of-service"});console.log("Filtering buses. Total:",this.buses().length,"Available:",a.length),this.availableBuses.set(a)},{allowSignalWrites:!0}),A(()=>{this.isTracking()&&this.currentBus()?this.watchId=navigator.geolocation.watchPosition(a=>{let{latitude:o,longitude:l,heading:f}=a.coords;this.location.set({lat:o,lng:l}),this.apiService.updateLocation(this.currentBus().id,o,l,f||0).subscribe(),this.checkStations(o,l)},a=>console.error(a),{enableHighAccuracy:!0,maximumAge:0,timeout:5e3}):this.stopLocationTracking()})}buses=m([]);selectedBus=m("");currentBus=m(null);isTracking=m(!1);issueType=m("");issueDescription=m("");location=m(null);availableBuses=m([]);user=m(null);watchId=null;ngOnInit(){let t=this.authService.getUser();console.log("Current user:",t),this.user.set(t),this.fetchBuses()}ngOnDestroy(){this.stopLocationTracking()}fetchBuses(){console.log("Fetching buses..."),this.apiService.getBuses().subscribe({next:t=>{if(console.log("Buses response:",t),console.log("Response type:",typeof t),console.log("Response keys:",Object.keys(t||{})),t&&t.buses){console.log("Buses array:",t.buses),console.log("Buses count:",t.buses.length),console.log("First bus:",t.buses[0]);let e=t.buses.map(o=>{let l=(o.status||"available").toLowerCase(),f=l==="active"||l==="out-of-service"?l:"available";return R(P({},o),{status:f})});this.buses.set(e),console.log("Buses signal set:",this.buses().length),console.log("Available buses:",this.availableBuses().length);let a=e.find(o=>o.currentDriverId===this.user()?.id&&o.status==="active");a&&(this.currentBus.set(a),this.selectedBus.set(a.id),this.isTracking.set(!0))}else console.warn("No buses in response. Response:",t),this.buses.set([])},error:t=>{console.error("Error fetching buses:",t),console.error("Error details:",t.error,t.status,t.statusText),this.buses.set([])}})}handleStartTrip(){if(!this.selectedBus()){alert("Please select a bus.");return}let t=this.user()?.id;if(console.log("Sending Bus ID:",this.selectedBus()),console.log("Sending Driver ID:",t),!t){alert("Driver ID not found. Please log in again.");return}this.apiService.startTrip(this.selectedBus(),t).subscribe({next:()=>{this.fetchBuses(),this.isTracking.set(!0)},error:e=>{alert(`Failed to start trip: ${e?.message||"Bus may be active or ID is invalid."}`),console.error("Start Trip Error:",e)}})}handleEndTrip(){this.currentBus()&&this.apiService.endTrip(this.currentBus().id).subscribe(()=>{this.currentBus.set(null),this.isTracking.set(!1),this.selectedBus.set(""),this.fetchBuses()})}handleReportIssue(){!this.currentBus()||!this.issueType()||!this.issueDescription()||this.apiService.reportIssue(this.currentBus().id,this.issueType(),this.issueDescription()).subscribe(()=>{this.currentBus.set(null),this.isTracking.set(!1),this.issueType.set(""),this.issueDescription.set(""),this.fetchBuses()})}handleRestoreBus(t){this.apiService.restoreBus(t).subscribe(()=>{alert("Bus restored to available"),this.fetchBuses()})}stopLocationTracking(){this.watchId!==null&&navigator.geolocation.clearWatch(this.watchId)}checkStations(t,e){let a=this.currentBus();if(!a?.stations)return;let o=5e-4;a.stations.forEach(l=>{!l.reached&&Math.abs(l.lat-t)<o&&Math.abs(l.lng-e)<o&&this.apiService.recordStation(a.id,l.name).subscribe()})}static \u0275fac=function(e){return new(e||s)(N(M),N(Q))};static \u0275cmp=j({type:s,selectors:[["app-driver-dashboard"]],standalone:!0,features:[H],decls:48,vars:5,consts:[["noActiveTrip",""],["noBuses",""],["noLocation",""],[1,"min-h-screen","bg-gray-50","py-8","px-4","sm:px-6","lg:px-8"],[1,"max-w-7xl","mx-auto","space-y-6"],[1,"mb-8"],[1,"text-3xl","font-bold","text-gray-900","mb-2"],[1,"text-gray-600"],[1,"bg-white","rounded-lg","shadow-md","p-6","mb-6"],[1,"text-xl","font-semibold","text-gray-900","mb-6"],[4,"ngIf","ngIfElse"],[1,"bg-gray-100","border","border-gray-200","rounded-lg","p-6"],[1,"text-lg","font-semibold","text-gray-900","mb-4"],[1,"space-y-2","text-gray-700"],[1,"flex","items-start"],[1,"text-blue-600","mr-2"],[1,"bg-blue-50","border","border-blue-200","rounded-lg","p-4","mb-4"],[1,"flex","justify-between","items-center"],[1,"flex-1"],[1,"text-sm","text-gray-600","mb-1"],[1,"text-2xl","font-bold","text-gray-900","mb-1"],[4,"ngIf"],[1,"bg-green-500","text-white","px-3","py-1","rounded-full","text-sm","font-medium"],[1,"bg-gray-50","border","border-gray-200","rounded-lg","p-3","mb-4","flex","items-center"],["class","w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse",4,"ngIf"],[1,"text-gray-700","text-sm"],[1,"mb-4"],["for","issueType",1,"block","text-sm","font-medium","text-gray-700","mb-2"],["id","issueType",1,"w-full","px-4","py-2","border","border-gray-300","rounded-lg","focus:ring-2","focus:ring-blue-500","focus:border-blue-500","outline-none","transition",3,"ngModelChange","ngModel"],["value",""],["value","mechanical"],["value","electrical"],["value","accident"],["value","other"],["for","issueDesc",1,"block","text-sm","font-medium","text-gray-700","mb-2"],["id","issueDesc","rows","3","placeholder","Describe the issue in detail...",1,"w-full","px-4","py-2","border","border-gray-300","rounded-lg","focus:ring-2","focus:ring-blue-500","focus:border-blue-500","outline-none","transition","resize-none",3,"ngModelChange","ngModel"],[1,"w-full","bg-yellow-500","hover:bg-yellow-600","text-white","font-medium","py-2","px-4","rounded-lg","transition","duration-200","mb-4",3,"click"],[1,"w-full","bg-red-600","hover:bg-red-700","text-white","font-medium","py-3","px-4","rounded-lg","transition","duration-200",3,"click"],[1,"text-gray-700"],[1,"bg-green-50","border","border-green-200","rounded-lg","p-4","mb-4"],["fill","currentColor","viewBox","0 0 16 16",1,"w-6","h-6","text-green-600","mr-3","mt-1","flex-shrink-0"],["d","M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10z"],["d","M8 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"],[1,"text-gray-900","font-mono","text-sm"],[1,"bg-yellow-50","border","border-yellow-200","text-yellow-800","rounded-lg","p-3","mb-4"],[1,"text-sm"],[1,"w-2","h-2","bg-green-500","rounded-full","mr-2","animate-pulse"],[1,"text-center","py-8"],["fill","none","stroke","currentColor","viewBox","0 0 24 24",1,"w-16","h-16","text-gray-400","mx-auto"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"],[1,"text-lg","font-medium","text-gray-900","mb-1"],[1,"text-gray-600","mb-6"],[1,"max-w-md","mx-auto"],["for","selectBus",1,"block","text-sm","font-medium","text-gray-700","mb-2","text-left"],["id","selectBus",1,"w-full","px-4","py-2","border","border-gray-300","rounded-lg","focus:ring-2","focus:ring-blue-500","focus:border-blue-500","outline-none","transition","mb-4",3,"ngModelChange","ngModel"],[3,"value",4,"ngFor","ngForOf"],["disabled","",4,"ngIf"],[1,"w-full","bg-green-600","hover:bg-green-700","disabled:bg-gray-400","disabled:cursor-not-allowed","text-white","font-medium","py-3","px-4","rounded-lg","transition","duration-200",3,"click","disabled"],[3,"value"],["disabled",""],[1,"grid","grid-cols-1","md:grid-cols-2","lg:grid-cols-3","gap-4"],["class","border border-gray-200 rounded-lg p-4 hover:shadow-md transition",4,"ngFor","ngForOf"],[1,"border","border-gray-200","rounded-lg","p-4","hover:shadow-md","transition"],[1,"flex","justify-between","items-center","mb-2"],[1,"text-lg","font-semibold","text-gray-900"],[1,"px-3","py-1","rounded-full","text-xs","font-medium",3,"ngClass"],["class","text-sm text-gray-600 mt-1",4,"ngIf"],["class","mt-3",4,"ngIf"],[1,"text-sm","text-gray-600","mt-1"],[1,"mt-3"],[1,"w-full","bg-blue-500","hover:bg-blue-600","text-white","font-medium","py-2","px-4","rounded-lg","transition","duration-200",3,"click"],[1,"text-center","py-8","text-gray-500"]],template:function(e,a){if(e&1&&(i(0,"div",3)(1,"div",4)(2,"div",5)(3,"h1",6),r(4,"Driver Dashboard"),n(),i(5,"p",7),r(6),n()(),i(7,"div",8)(8,"h2",9),r(9,"Current Trip Status"),n(),p(10,pe,43,8,"ng-container",10)(11,he,18,4,"ng-template",null,0,k),n(),i(13,"div",8)(14,"h2",9),r(15,"Bus Fleet Status"),n(),p(16,_e,3,1,"div",10),n()()(),p(17,ye,2,0,"ng-template",null,1,k),i(19,"div",11)(20,"h3",12),r(21,"Driver Instructions"),n(),i(22,"ul",13)(23,"li",14)(24,"span",15),r(25,"\u2022"),n(),i(26,"span"),r(27,'Select your bus from the dropdown and click "Start Trip" to begin'),n()(),i(28,"li",14)(29,"span",15),r(30,"\u2022"),n(),i(31,"span"),r(32,"Your location will be tracked automatically during the trip"),n()(),i(33,"li",14)(34,"span",15),r(35,"\u2022"),n(),i(36,"span"),r(37,'Click "End Trip" when you complete your route'),n()(),i(38,"li",14)(39,"span",15),r(40,"\u2022"),n(),i(41,"span"),r(42,"Report any issues immediately using the issue report form"),n()(),i(43,"li",14)(44,"span",15),r(45,"\u2022"),n(),i(46,"span"),r(47,"Ensure location services are enabled on your device"),n()()()()),e&2){let o,l=D(12),f=D(18);c(6),v(" Welcome, ",((o=a.user())==null?null:o.name)||"Driver","! Manage your trips and bus status. "),c(4),d("ngIf",a.currentBus())("ngIfElse",l),c(6),d("ngIf",a.buses().length>0)("ngIfElse",f)}},dependencies:[q,z,G,Y,re,ie,ne,X,te,Z,ee],styles:[".min-h-screen[_ngcontent-%COMP%]{min-height:100vh}.bg-gradient-to-br[_ngcontent-%COMP%]{background-image:linear-gradient(to bottom right,var(--tw-gradient-stops))}.text-slate-900[_ngcontent-%COMP%]{color:#0f172a}.text-slate-600[_ngcontent-%COMP%]{color:#475569}.text-slate-500[_ngcontent-%COMP%]{color:#6b7280}.bg-blue-50[_ngcontent-%COMP%]{background-color:#eff6ff}.border-blue-200[_ngcontent-%COMP%]{border-color:#bfdbfe}.bg-green-50[_ngcontent-%COMP%]{background-color:#ecfdf5}.border-green-200[_ngcontent-%COMP%]{border-color:#bbf7d0}.bg-yellow-50[_ngcontent-%COMP%]{background-color:#fef3c7}.border-yellow-200[_ngcontent-%COMP%]{border-color:#fde68a}"]})};export{oe as DriverDashboardComponent};
